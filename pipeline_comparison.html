<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSE-UKHSA Pipeline Evolution</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }
        h1 {
            text-align: center;
            color: #2C3E50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .diagram-container {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 10px;
            margin-bottom: 20px;
        }
        .diagram-wrapper {
            display: none;
        }
        .diagram-wrapper.active {
            display: block;
        }
        .nav-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 10px;
        }
        .nav-arrow {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5DADE2 0%, #3498db 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(93, 173, 226, 0.4);
        }
        .nav-arrow:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(93, 173, 226, 0.6);
        }
        .nav-arrow:active {
            transform: scale(0.95);
        }
        .nav-arrow svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        .nav-arrow:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            box-shadow: none;
        }
        .nav-arrow:disabled:hover {
            transform: none;
        }
        .version-indicator {
            text-align: center;
        }
        .version-badge {
            display: inline-block;
            padding: 8px 24px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            min-width: 200px;
        }
        .version-old {
            background: #ffeaa7;
            color: #b7950b;
        }
        .version-new {
            background: #d5f4e6;
            color: #27ae60;
        }
        .diagram-title {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 15px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #555;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .comparison-note {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px 20px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
        }
        .comparison-note h3 {
            color: #2C3E50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .comparison-note ul {
            margin-left: 20px;
            color: #555;
            font-size: 14px;
        }
        .comparison-note li {
            margin-bottom: 5px;
        }
        .highlight {
            color: #27ae60;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-container">
            <button class="nav-arrow" id="prevBtn" onclick="navigate(-1)">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </button>
            <div class="version-indicator">
                <span class="version-badge version-old" id="versionBadge">Original Pipeline (v1)</span>
            </div>
            <button class="nav-arrow" id="nextBtn" onclick="navigate(1)">
                <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </button>
        </div>
        
        <div class="diagram-container">
            <div class="diagram-wrapper active" id="diagram-0">
                <div id="old-pipeline"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background: #5DADE2;"></div> APIs / Data Sources</div>
                    <div class="legend-item"><div class="legend-color" style="background: #808B96;"></div> Processing Notebooks</div>
                    <div class="legend-item"><div class="legend-color" style="background: #F4D03F;"></div> Output Data Files</div>
                </div>
            </div>
            
            <div class="diagram-wrapper" id="diagram-1">
                <div id="new-pipeline"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background: #5DADE2;"></div> Sources / APIs / Applications</div>
                    <div class="legend-item"><div class="legend-color" style="background: #808B96;"></div> Processing Notebooks</div>
                    <div class="legend-item"><div class="legend-color" style="background: #F4D03F;"></div> Output Data Files</div>
                </div>
            </div>
        </div>
        
        <div class="comparison-note">
            <h3>Key Differences Between Versions</h3>
            <ul>
                <li><span class="highlight">PDF Processing:</span> New pipeline adds dedicated PDF download (Wiley TDM API) and reference extraction (PyMuPDF) stages</li>
                <li><span class="highlight">Reference Matching:</span> Enhanced pipeline uses CrossRef API for bibliographic matching, dramatically improving match rates</li>
                <li><span class="highlight">Data Volume:</span> Original: ~1,000 validation records → Enhanced: <span class="highlight">4,089</span> validation records (Public Health subset)</li>
                <li><span class="highlight">Notebooks:</span> 4 notebooks → 6 notebooks with clearer separation of concerns</li>
            </ul>
        </div>
    </div>

    <script>
        let currentDiagram = 0;
        const totalDiagrams = 2;
        
        function navigate(direction) {
            currentDiagram += direction;
            if (currentDiagram < 0) currentDiagram = 0;
            if (currentDiagram >= totalDiagrams) currentDiagram = totalDiagrams - 1;
            
            // Update visibility
            document.querySelectorAll('.diagram-wrapper').forEach((el, i) => {
                el.classList.toggle('active', i === currentDiagram);
            });
            
            // Update badge
            const badge = document.getElementById('versionBadge');
            if (currentDiagram === 0) {
                badge.textContent = 'Original Pipeline (v1)';
                badge.className = 'version-badge version-old';
            } else {
                badge.textContent = 'Enhanced Pipeline (v2)';
                badge.className = 'version-badge version-new';
            }
            
            // Update buttons
            document.getElementById('prevBtn').disabled = currentDiagram === 0;
            document.getElementById('nextBtn').disabled = currentDiagram === totalDiagrams - 1;
        }
        
        // Initialize button states
        navigate(0);
        
        // =====================================================
        // OLD PIPELINE (Original horizontal swim-lane layout)
        // =====================================================
        function createOldPipeline() {
            const shapes = [];
            const annotations = [];
            
            const API_COLOR = '#5DADE2';
            const NB_COLOR = '#808B96';
            const OUT_COLOR = '#F4D03F';
            const ARROW_COLOR = '#E74C3C';
            const DARK = '#2C3E50';
            
            // Row positions (y) - using 0-10 scale
            const API_Y = 8;
            const NB_Y = 5;
            const OUT_Y = 2;
            
            // Background swim lanes (full width 0-10)
            shapes.push({
                type: 'rect', x0: 0.8, y0: 6.5, x1: 10, y1: 9.5,
                fillcolor: 'rgba(173, 216, 230, 0.3)', line: {width: 0}, layer: 'below'
            });
            shapes.push({
                type: 'rect', x0: 0.8, y0: 3.5, x1: 10, y1: 6.5,
                fillcolor: 'rgba(200, 200, 200, 0.2)', line: {width: 0}, layer: 'below'
            });
            shapes.push({
                type: 'rect', x0: 0.8, y0: 0.5, x1: 10, y1: 3.5,
                fillcolor: 'rgba(255, 235, 153, 0.4)', line: {width: 0}, layer: 'below'
            });
            
            // Dashed horizontal dividers
            shapes.push({
                type: 'line', x0: 0.8, y0: 6.5, x1: 10, y1: 6.5,
                line: {color: '#aaa', width: 1, dash: 'dash'}
            });
            shapes.push({
                type: 'line', x0: 0.8, y0: 3.5, x1: 10, y1: 3.5,
                line: {color: '#aaa', width: 1, dash: 'dash'}
            });
            
            // Row labels (positioned in left margin area)
            annotations.push({x: 0.4, y: API_Y, text: '<b>APIs</b>', showarrow: false, 
                font: {size: 14, color: API_COLOR}, textangle: -90});
            annotations.push({x: 0.4, y: NB_Y, text: '<b>Notebooks</b>', showarrow: false, 
                font: {size: 14, color: NB_COLOR}, textangle: -90});
            annotations.push({x: 0.4, y: OUT_Y, text: '<b>Outputs</b>', showarrow: false, 
                font: {size: 14, color: '#B7950B'}, textangle: -90});
            
            function addBox(x, y, w, h, text, color, fontColor='white', fontSize=11) {
                shapes.push({
                    type: 'rect', x0: x-w/2, y0: y-h/2, x1: x+w/2, y1: y+h/2,
                    fillcolor: color, line: {color: DARK, width: 1.5}, layer: 'below'
                });
                annotations.push({x: x, y: y, text: text, showarrow: false, 
                    font: {size: fontSize, color: fontColor}, align: 'center'});
            }
            
            function addArrow(x0, y0, x1, y1, color=ARROW_COLOR) {
                annotations.push({
                    x: x1, y: y1, ax: x0, ay: y0,
                    xref: 'x', yref: 'y', axref: 'x', ayref: 'y',
                    showarrow: true, arrowhead: 2, arrowsize: 1, arrowwidth: 1.5, arrowcolor: color
                });
            }
            
            // APIs row (spread across x=1.5 to x=9)
            addBox(2, API_Y, 1.8, 1.2, 'PubMed API<br>(NCBI Entrez)', API_COLOR, 'white', 12);
            addBox(5.5, API_Y, 1.8, 1.2, 'PubMed API<br>(NCBI Entrez)', API_COLOR, 'white', 12);
            addBox(8.5, API_Y, 1.6, 1.2, 'Ollama<br>(Local LLMs)', API_COLOR, 'white', 12);
            
            // Notebooks row
            addBox(2, NB_Y, 2.0, 1.2, '00_obtain_cochrane<br>_abstracts.ipynb', NB_COLOR, 'white', 11);
            addBox(4.5, NB_Y, 2.0, 1.2, '02_fetch_referenced<br>_abstracts.ipynb', NB_COLOR, 'white', 11);
            addBox(6.8, NB_Y, 1.8, 1.2, '03_build_ground<br>_truth.ipynb', NB_COLOR, 'white', 11);
            addBox(8.8, NB_Y, 1.6, 1.2, '04_llm<br>_evaluation.ipynb', NB_COLOR, 'white', 11);
            
            // Outputs row
            addBox(1.6, OUT_Y, 1.4, 1.4, 'cochrane_pubmed<br>_abstracts.csv<br>(17,092 reviews)', OUT_COLOR, DARK, 10);
            addBox(3.3, OUT_Y, 1.4, 1.4, 'cochrane_pubmed<br>_references.csv<br>(1.18M edges)', OUT_COLOR, DARK, 10);
            addBox(5.0, OUT_Y, 1.4, 1.4, 'referenced_paper<br>_abstracts.csv<br>(491K papers)', OUT_COLOR, DARK, 10);
            addBox(6.8, OUT_Y, 1.5, 1.4, 'ground_truth<br>_validation_set.csv<br>(1,000 records)', OUT_COLOR, DARK, 10);
            addBox(8.7, OUT_Y, 1.4, 1.2, 'results/<br>eval_*.csv', OUT_COLOR, DARK, 10);
            
            // Arrows: API → Notebooks
            addArrow(2, API_Y-0.7, 2, NB_Y+0.7, DARK);
            addArrow(5.5, API_Y-0.7, 4.5, NB_Y+0.7, DARK);
            addArrow(8.5, API_Y-0.7, 8.8, NB_Y+0.7, DARK);
            
            // Arrows: Notebooks → Outputs
            addArrow(2, NB_Y-0.7, 1.6, OUT_Y+0.8);
            addArrow(2, NB_Y-0.7, 3.3, OUT_Y+0.8);
            addArrow(4.5, NB_Y-0.7, 5.0, OUT_Y+0.8);
            addArrow(6.8, NB_Y-0.7, 6.8, OUT_Y+0.8);
            addArrow(8.8, NB_Y-0.7, 8.7, OUT_Y+0.7);
            
            // Horizontal arrows between outputs
            addArrow(2.4, OUT_Y, 2.5, OUT_Y);
            addArrow(4.1, OUT_Y, 4.2, OUT_Y);
            addArrow(5.8, OUT_Y, 5.9, OUT_Y);
            addArrow(7.6, OUT_Y, 7.9, OUT_Y);
            
            const layout = {
                xaxis: {range: [0, 10], showgrid: false, zeroline: false, showticklabels: false, fixedrange: true},
                yaxis: {range: [0, 10], showgrid: false, zeroline: false, showticklabels: false, fixedrange: true, scaleanchor: 'x', scaleratio: 0.5},
                shapes: shapes,
                annotations: annotations,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                autosize: true,
                margin: {l: 5, r: 5, t: 5, b: 5}
            };
            
            Plotly.newPlot('old-pipeline', [], layout, {displayModeBar: false, responsive: true});
        }
        
        // =====================================================
        // NEW PIPELINE - EXPANDED LAYOUT
        // =====================================================
        function createNewPipeline() {
            const shapes = [];
            const annotations = [];
            
            const API_COLOR = '#5DADE2';
            const NB_COLOR = '#808B96';
            const OUT_COLOR = '#F4D03F';
            const ARROW_COLOR = '#E74C3C';
            const DARK = '#2C3E50';
            
            // Background regions - expanded
            shapes.push({
                type: 'rect', x0: 0.5, y0: 8.5, x1: 14.5, y1: 10.0,
                fillcolor: 'rgba(173, 216, 230, 0.3)', line: {width: 0}, layer: 'below'
            });
            shapes.push({
                type: 'rect', x0: 11.5, y0: 0.2, x1: 14.5, y1: 8.5,
                fillcolor: 'rgba(255, 235, 153, 0.4)', line: {width: 0}, layer: 'below'
            });
            
            // Section labels
            annotations.push({x: 7.5, y: 9.7, text: '<b>Sources / APIs / Applications</b>', showarrow: false,
                font: {size: 15, color: API_COLOR}});
            annotations.push({x: 13.0, y: 8.2, text: '<b>Outputs</b>', showarrow: false,
                font: {size: 15, color: '#B7950B'}});
            annotations.push({x: 5.0, y: 7.8, text: '<b>Notebooks</b>', showarrow: false,
                font: {size: 15, color: NB_COLOR}});
            
            function addBox(x, y, w, h, text, color, fontColor='white', fontSize=12) {
                shapes.push({
                    type: 'rect', x0: x-w/2, y0: y-h/2, x1: x+w/2, y1: y+h/2,
                    fillcolor: color, line: {color: DARK, width: 1.5}, layer: 'below'
                });
                annotations.push({x: x, y: y, text: text, showarrow: false,
                    font: {size: fontSize, color: fontColor}, align: 'center'});
            }
            
            function addArrow(x0, y0, x1, y1, color=ARROW_COLOR) {
                annotations.push({
                    x: x1, y: y1, ax: x0, ay: y0,
                    xref: 'x', yref: 'y', axref: 'x', ayref: 'y',
                    showarrow: true, arrowhead: 2, arrowsize: 1.2, arrowwidth: 2, arrowcolor: color
                });
            }
            
            // APIs (top row) - spread across full width
            addBox(1.5, 9.2, 2.0, 0.8, 'PubMed API<br>(NCBI Entrez)', API_COLOR, 'white', 11);
            addBox(4.5, 9.2, 2.0, 0.8, 'Wiley TDM<br>API', API_COLOR, 'white', 11);
            addBox(7.5, 9.2, 1.8, 0.8, 'CrossRef<br>API', API_COLOR, 'white', 11);
            addBox(10.5, 9.2, 2.0, 0.8, 'PubMed API<br>(NCBI Entrez)', API_COLOR, 'white', 11);
            addBox(13.5, 9.2, 1.8, 0.8, 'Ollama<br>(Local LLMs)', API_COLOR, 'white', 11);
            
            // Notebooks - staggered diagonal with more space
            addBox(2.0, 7.0, 2.8, 1.0, '00_obtain_cochrane<br>_abstracts.ipynb', NB_COLOR, 'white', 11);
            addBox(4.5, 5.6, 2.8, 1.0, '02_fetch_cochrane<br>_pdfs.ipynb', NB_COLOR, 'white', 11);
            addBox(6.5, 4.2, 3.0, 1.0, '03_extract_metadata<br>_and_references.ipynb', NB_COLOR, 'white', 10);
            addBox(8.5, 2.8, 3.0, 1.0, '04_fetch_referenced<br>_abstracts.ipynb', NB_COLOR, 'white', 11);
            addBox(6.5, 1.5, 2.8, 1.0, '05_build_ground<br>_truth.ipynb', NB_COLOR, 'white', 11);
            addBox(10.0, 0.5, 2.4, 0.9, '06_evaluate<br>_llms.ipynb', NB_COLOR, 'white', 11);
            
            // Outputs (right side) - larger boxes
            addBox(13.0, 7.0, 2.4, 1.0, 'cochrane_pubmed<br>_abstracts.csv<br>(17,298 reviews)', OUT_COLOR, DARK, 10);
            addBox(13.0, 5.6, 2.4, 1.0, 'cochrane_pdfs/<br>(16,588 PDFs)', OUT_COLOR, DARK, 10);
            addBox(13.0, 4.2, 2.4, 1.0, 'categorized<br>_references.csv<br>(629K refs)', OUT_COLOR, DARK, 10);
            addBox(13.0, 2.8, 2.4, 1.0, 'referenced_paper<br>_abstracts.csv<br>(47,518 papers)', OUT_COLOR, DARK, 10);
            addBox(13.0, 1.5, 2.4, 1.0, 'ground_truth<br>_validation.csv<br>(4,089 records)', OUT_COLOR, DARK, 10);
            addBox(13.0, 0.5, 2.4, 0.9, 'results/<br>eval_*.csv', OUT_COLOR, DARK, 11);
            
            // Arrows: APIs → Notebooks
            addArrow(1.5, 8.75, 2.0, 7.55, DARK);    // PubMed → 00
            addArrow(4.5, 8.75, 4.5, 6.15, DARK);    // Wiley → 02
            addArrow(7.5, 8.75, 8.5, 3.35, DARK);    // CrossRef → 04
            addArrow(10.5, 8.75, 8.5, 3.35, DARK);   // PubMed → 04
            addArrow(13.5, 8.75, 10.0, 1.0, DARK);   // Ollama → 06
            
            // Arrows: Notebooks → Outputs (horizontal)
            addArrow(3.5, 7.0, 11.7, 7.0);     // 00 → abstracts
            addArrow(6.0, 5.6, 11.7, 5.6);     // 02 → pdfs
            addArrow(8.1, 4.2, 11.7, 4.2);     // 03 → refs
            addArrow(10.1, 2.8, 11.7, 2.8);    // 04 → papers
            addArrow(8.0, 1.5, 11.7, 1.5);     // 05 → GT
            addArrow(11.3, 0.5, 11.7, 0.5);    // 06 → eval results
            
            // Arrows: Notebook flow (diagonal)
            addArrow(3.0, 6.45, 3.9, 6.15);    // 00 → 02
            addArrow(5.4, 5.05, 5.9, 4.75);    // 02 → 03
            addArrow(7.5, 3.65, 7.9, 3.35);    // 03 → 04
            addArrow(7.9, 2.25, 7.4, 2.05);    // 04 → 05
            addArrow(8.0, 1.0, 8.7, 1.0);      // 05 → 06
            
            const layout = {
                xaxis: {range: [0, 15], showgrid: false, zeroline: false, showticklabels: false, fixedrange: true},
                yaxis: {range: [0, 10.5], showgrid: false, zeroline: false, showticklabels: false, fixedrange: true},
                shapes: shapes,
                annotations: annotations,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                autosize: true,
                margin: {l: 5, r: 5, t: 5, b: 5}
            };
            
            Plotly.newPlot('new-pipeline', [], layout, {displayModeBar: false, responsive: true});
        }
        
        // Initialize both diagrams
        createOldPipeline();
        createNewPipeline();
    </script>
</body>
</html>
